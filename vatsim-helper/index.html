<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Helper to VATSIM Communication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The application is structured around user tasks rather than the report's linear sections. A primary tab-based navigation allows users to jump directly to their key questions: 'Get Prepared', 'Who Do I Call?', 'What Do I Say (IFR/UNICOM)?', and 'Quick Reference'. This task-oriented design is more intuitive for a new user trying to solve a specific problem (e.g., "I'm at the gate, who do I talk to?"). The 'Who Do I Call?' section is the core interactive element, turning the abstract 'Top-Down' rule into a tangible tool. The 'What Do I Say?' sections break down the long flight script into clickable, manageable phases, reducing information overload. This structure is designed to build confidence by providing clear, accessible answers in an interactive format. -->
    <!-- Visualization & Content Choices: The report's information is primarily procedural and textual. Therefore, the focus is on interactive organization rather than data visualization. Report Info: ATC Hierarchy & Top-Down Rule -> Goal: Organize/Explain -> Viz/Presentation: Interactive toggle-based diagram -> Interaction: User toggles controller statuses to see who to call -> Justification: Makes the most confusing VATSIM rule interactive and easy to understand. Library/Method: Vanilla JS, HTML/CSS. Report Info: IFR/UNICOM Phraseology -> Goal: Inform/Organize -> Viz/Presentation: Accordion/Tabbed content -> Interaction: User clicks a flight phase to reveal specific phrases -> Justification: Breaks down intimidating scripts into digestible, context-specific chunks. Library/Method: Vanilla JS, HTML/CSS. Report Info: Phonetic Alphabet -> Goal: Inform -> Viz/Presentation: Styled HTML table -> Interaction: Static reference. Justification: Clear and standard presentation. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            background-color: #f5f5f4; /* stone-100 */
            color: #27272a; /* zinc-800 */
            font-family: 'Inter', sans-serif;
        }
        @import url('https://rsms.me/inter/inter.css');
        .nav-button {
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid transparent;
        }
        .nav-button.active {
            border-bottom-color: #0891b2; /* cyan-600 */
            color: #0e7490; /* cyan-700 */
        }
        .nav-button:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .accordion-button {
            transition: background-color 0.2s;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .dialogue {
            border-left: 3px solid;
            padding-left: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .pilot-dialogue {
            border-color: #0891b2; /* cyan-600 */
        }
        .atc-dialogue {
            border-color: #be123c; /* rose-700 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0891b2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl">Interactive Helper to VATSIM Communication</h1>
                <p class="mt-4 text-xl text-gray-600">Your co-pilot for mastering radio calls and procedures on the network.</p>
                <div id="flight-plan-inputs" class="mt-6 max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <input type="text" id="departure-icao" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Departure ICAO (e.g., EHAM)">
                    <input type="text" id="arrival-icao" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Arrival ICAO (e.g., EGLL)">
                    <input type="text" id="callsign-input" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Callsign (e.g., Vueling 016)">
                    <button id="fetch-flight-btn" class="sm:col-span-3 bg-cyan-600 text-white font-bold py-3 px-6 rounded-md hover:bg-cyan-700 transition-colors">Fetch Frequencies & Build Script</button>
                </div>
            </div>
        </header>

        <main class="py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                 <div id="flight-results-container" class="mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div id="departure-results"></div>
                        <div id="arrival-results"></div>
                    </div>
                </div>

                <nav id="main-nav" class="flex flex-wrap justify-center border-b border-gray-300 mb-8">
                    <button data-target="prepare" class="nav-button active text-lg font-medium py-4 px-6">1. Get Prepared</button>
                    <button data-target="who-to-call" class="nav-button text-lg font-medium py-4 px-6">2. Who Do I Call? (Live)</button>
                    <button data-target="ifr-calls" class="nav-button text-lg font-medium py-4 px-6">3. IFR Phraseology (Live)</button>
                    <button data-target="unicom-calls" class="nav-button text-lg font-medium py-4 px-6">4. UNICOM Phraseology</button>
                    <button data-target="reference" class="nav-button text-lg font-medium py-4 px-6">5. Quick Reference</button>
                </nav>

                <div id="content-container">
                    <!-- Section 1: Get Prepared -->
                    <section id="prepare" class="content-section active">
                        <div class="text-center mb-12">
                            <h2 class="text-3xl font-bold text-gray-900">Foundations of Radio Discipline</h2>
                            <p class="mt-2 text-lg text-gray-600">Success on the network starts before you connect. Strong preparation is the key to minimizing stress and ensuring smooth communication for everyone.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-3 text-cyan-800">‚úàÔ∏è Aircraft Familiarity</h3>
                                <p class="text-gray-700">This is the most critical step. You must be comfortable with your aircraft's systems, especially the autopilot and FMS, *before* adding ATC. Controllers issue instructions with the expectation you can comply quickly. Practice offline until you can confidently manage your aircraft's speed, heading, and altitude without hesitation.</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-3 text-cyan-800">üó∫Ô∏è Flight Plan & Charts</h3>
                                <p class="text-gray-700">Always file a valid flight plan before connecting. Have all necessary charts for your route: Airport Diagrams, SIDs, STARs, and En-route charts. An instruction like "Taxi to holding point Alpha 1 via Kilo" is impossible without the airport diagram. Not having charts creates unnecessary delays for you and the controller.</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-3 text-cyan-800">üìú The Rules of the Radio</h3>
                                <p class="text-gray-700"><strong class="block mb-1">Listen before you speak.</strong> This prevents cutting someone off. Your first call should almost always follow this structure: <strong class="text-cyan-900">1. Who you're calling, 2. Who you are, 3. What you want.</strong> Example: "Luton Ground, Easy 123, request pushback."</p>
                            </div>
                        </div>
                    </section>

                    <!-- Section 2: Who Do I Call? -->
                    <section id="who-to-call" class="content-section">
                        <div class="text-center mb-12">
                            <h2 class="text-3xl font-bold text-gray-900">Live Top-Down Service Guide</h2>
                            <p class="mt-2 text-lg text-gray-600">Based on the live VATSIM data for your flight plan, here is the correct controller to contact for each phase of flight.</p>
                        </div>
                        <div id="top-down-results" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div class="bg-white p-8 rounded-lg shadow-lg text-center md:col-span-2">
                                <p class="text-gray-600">Enter a departure, arrival ICAO, and callsign in the header and click "Fetch Frequencies" to see live controller information here.</p>
                            </div>
                        </div>
                    </section>

                    <!-- Section 3: IFR Phraseology -->
                    <section id="ifr-calls" class="content-section">
                        <div class="text-center mb-12">
                             <h2 class="text-3xl font-bold text-gray-900">Live IFR Flight Phraseology</h2>
                             <p class="mt-2 text-lg text-gray-600">This is a personalized walkthrough of a standard IFR flight using your callsign and live ATC data. Click on each phase to see the typical exchange.</p>
                        </div>
                        <div class="space-y-2" id="ifr-accordion">
                           <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                                <p class="text-gray-600">Enter your flight details in the header and click "Fetch Frequencies" to generate your personalized script.</p>
                            </div>
                        </div>
                    </section>

                     <!-- Section 4: UNICOM Phraseology -->
                    <section id="unicom-calls" class="content-section">
                        <div class="text-center mb-12">
                             <h2 class="text-3xl font-bold text-gray-900">UNICOM Phraseology (122.800)</h2>
                            <p class="mt-2 text-lg text-gray-600">When no ATC is online, you must self-report your position and intentions on the UNICOM frequency. This is advisory, not instructional. The goal is to let other pilots know where you are and what you're doing. All calls should start with the airport name.</p>
                        </div>
                        <div class="space-y-2" id="unicom-accordion">
                             <!-- Accordion items will be generated by JS -->
                        </div>
                    </section>

                    <!-- Section 5: Quick Reference -->
                    <section id="reference" class="content-section">
                         <div class="text-center mb-12">
                             <h2 class="text-3xl font-bold text-gray-900">Quick Reference</h2>
                             <p class="mt-2 text-lg text-gray-600">Essential information at your fingertips. Use this for the phonetic alphabet and how to handle common situations.</p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-4 text-cyan-800">ICAO Phonetic Alphabet & Numbers</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-slate-100">
                                            <tr>
                                                <th class="p-2">Letter</th><th class="p-2">Code</th><th>Pronunciation</th>
                                                <th class="p-2">Num</th><th class="p-2">Pronunciation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="phonetic-table-body">
                                            <!-- Data will be populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-4 text-cyan-800">Handling the Unexpected</h3>
                                <div class="space-y-4">
                                    <div>
                                        <h4 class="font-bold text-lg">Instruction Unclear?</h4>
                                        <p class="text-gray-700">Never guess. The most important phrase is <strong class="text-rose-700">"Say again."</strong> Controllers would much rather repeat themselves than have you perform a wrong action. Simply say: <code class="bg-gray-200 p-1 rounded">"Say again for [Your Callsign]."</code></p>
                                    </div>
                                     <div>
                                        <h4 class="font-bold text-lg">Made a Mistake?</h4>
                                        <p class="text-gray-700">It happens! VATSIM is a learning environment. The controller will correct you. Acknowledge the correction, comply with the new instruction, and move on. Don't panic.</p>
                                    </div>
                                     <div>
                                        <h4 class="font-bold text-lg">Simulated Emergency</h4>
                                        <p class="text-gray-700">Declare it with <strong class="text-rose-700">"Mayday, Mayday, Mayday."</strong> State your callsign, position, the nature of the emergency, and your intentions. Squawk 7700. Be aware controllers can deny emergency requests if traffic prevents them from accommodating. <strong class="font-bold">Never use squawk codes 7500 or 7600.</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const mainNav = document.getElementById('main-nav');
    const contentContainer = document.getElementById('content-container');

    mainNav.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const targetId = e.target.dataset.target;

            mainNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            contentContainer.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                if (section.id === targetId) {
                    section.classList.add('active');
                }
            });
        }
    });

    const unicomData = [
        {
            title: "Before Movement (Pushback/Taxi)",
            content: `<p class="mb-4">Alerts other aircraft on the ground you are about to become mobile. State your location and intention.</p>
                     <div class="dialogue pilot-dialogue"><strong>Example Voice/Text:</strong> "[Airport Name] Traffic, [Callsign], at gate 23, pushing back for departure."</div>
                     <div class="dialogue pilot-dialogue"><strong>Example Voice/Text:</strong> "Frankfurt Traffic, Lufthansa 228, taxiing to runway 18."</div>`
        },
        {
            title: "At the Runway (Departure)",
            content: `<p class="mb-4">Crucial for runway safety. Announce you are entering the runway and your departure details.</p>
                     <div class="dialogue pilot-dialogue"><strong>Example Voice/Text:</strong> "Svalbard Traffic, SAS4488, entering runway 27 for departure."</div>
                     <div class="dialogue pilot-dialogue"><strong>Example Voice/Text:</strong> "Svalbard Traffic, SAS4488, departing runway 27, climbing to the northwest."</div>`
        },
        {
            title: "In the Air (Arrival)",
            content: `<p class="mb-4">Announce your position relative to the airport and your intended approach. Provide updates as you get closer.</p>
                     <div class="dialogue pilot-dialogue"><strong>Example Voice/Text:</strong> "Svalbard Traffic, SAS4488, 10 miles northwest at 4000 feet, inbound for the ILS runway 27 approach."</div>
                     <div class="dialogue pilot-dialogue"><strong>Example for VFR:</strong> "Teuge Traffic, PH-AVP, entering right downwind for runway 26."</div>
                     <div class="dialogue pilot-dialogue"><strong>Example on Final:</strong> "Teuge Traffic, PH-AVP, on final, runway 26."</div>`
        },
        {
            title: "After Landing",
            content: `<p class="mb-4">Announce that the runway is clear so other aircraft know it is safe to use.</p>
                     <div class="dialogue pilot-dialogue"><strong>Example Voice/Text:</strong> "Teuge Traffic, PH-AVP, runway 26 vacated."</div>`
        }
    ];

    function createAccordion(containerId, data) {
        const container = document.getElementById(containerId);
        if (!container || !data) return;
        container.innerHTML = data.map((item, index) => `
            <div class="bg-white rounded-lg shadow-sm">
                <h2>
                    <button type="button" class="accordion-button flex items-center justify-between w-full p-5 font-medium text-left text-gray-700 hover:bg-slate-100 focus:outline-none" data-accordion-target="accordion-body-${containerId}-${index}">
                        <span>${item.title}</span>
                        <svg class="w-6 h-6 shrink-0 transform" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </h2>
                <div id="accordion-body-${containerId}-${index}" class="accordion-content">
                    <div class="p-5 border-t border-gray-200">${item.content}</div>
                </div>
            </div>
        `).join('');

        container.addEventListener('click', e => {
            const button = e.target.closest('.accordion-button');
            if (!button) return;

            const content = document.getElementById(button.dataset.accordionTarget);
            const icon = button.querySelector('svg');
            
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.classList.remove('rotate-180');
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.classList.add('rotate-180');
            }
        });
    }
    
    createAccordion('unicom-accordion', unicomData);
    
    const phoneticData = [
        ['A', 'Alfa', 'AL-FAH', '0', 'ZE-RO'], ['B', 'Bravo', 'BRAH-VOH', '1', 'WUN'],
        ['C', 'Charlie', 'CHAR-LEE', '2', 'TOO'], ['D', 'Delta', 'DELL-TAH', '3', 'TREE'],
        ['E', 'Echo', 'ECK-OH', '4', 'FOW-ER'], ['F', 'Foxtrot', 'FOKS-TROT', '5', 'FIFE'],
        ['G', 'Golf', 'GOLF', '6', 'SIX'], ['H', 'Hotel', 'HOH-TEL', '7', 'SEV-EN'],
        ['I', 'India', 'IN-DEE-AH', '8', 'AIT'], ['J', 'Juliett', 'JEW-LEE-ETT', '9', 'NIN-ER'],
        ['K', 'Kilo', 'KEY-LOH', '', ''], ['L', 'Lima', 'LEE-MAH', '', ''],
        ['M', 'Mike', 'MIKE', '', ''], ['N', 'November', 'NO-VEM-BER', '', ''],
        ['O', 'Oscar', 'OSS-CAH', '', ''], ['P', 'Papa', 'PAH-PAH', '', ''],
        ['Q', 'Quebec', 'KEH-BECK', '', ''], ['R', 'Romeo', 'ROW-ME-OH', '', ''],
        ['S', 'Sierra', 'SEE-AIR-RAH', '', ''], ['T', 'Tango', 'TANG-GO', '', ''],
        ['U', 'Uniform', 'YOU-NEE-FORM', '', ''], ['V', 'Victor', 'VIK-TAH', '', ''],
        ['W', 'Whiskey', 'WISS-KEY', '', ''], ['X', 'X-ray', 'ECKS-RAY', '', ''],
        ['Y', 'Yankee', 'YANG-KEY', '', ''], ['Z', 'Zulu', 'ZOO-LOO', '', '']
    ];

    const phoneticTableBody = document.getElementById('phonetic-table-body');
    phoneticTableBody.innerHTML = phoneticData.map(row => `
        <tr class="border-b">
            <td class="p-2 font-bold">${row[0]}</td>
            <td class="p-2">${row[1]}</td>
            <td class="p-2 text-sm text-gray-600">${row[2]}</td>
            <td class="p-2 font-bold">${row[3]}</td>
            <td class="p-2 text-sm text-gray-600">${row[4]}</td>
        </tr>
    `).join('');

    const airportDatabase = [
        { icao: 'EHAM', name: 'Amsterdam Schiphol', center: 'EHAA_CTR', freqs: { ATIS: '132.975', DEL: '121.900', GND: '121.700', TWR: '118.275', APP: '119.050' } },
        { icao: 'EGLL', name: 'London Heathrow', center: 'EGTT_CTR', freqs: { ATIS: '128.075', DEL: '121.975', GND: '121.900', TWR: '118.500', APP: '119.725' } },
        { icao: 'EDDF', name: 'Frankfurt am Main', center: 'EDGG_CTR', freqs: { ATIS: '131.040', DEL: '121.825', GND: '121.900', TWR: '119.900', APP: '119.150' } },
        { icao: 'LFPG', name: 'Paris Charles de Gaulle', center: 'LFFF_CTR', freqs: { ATIS: '129.500', DEL: '120.050', GND: '121.605', TWR: '118.150', APP: '120.300' } },
        { icao: 'EGKK', name: 'London Gatwick', center: 'EGTT_CTR', freqs: { ATIS: '136.525', DEL: '121.800', GND: '121.800', TWR: '124.225', APP: '129.025' } },
        { icao: 'EDDM', name: 'Munich Airport', center: 'EDGG_CTR', freqs: { ATIS: '123.055', DEL: '121.755', GND: '121.705', TWR: '118.700', APP: '120.650' } },
        { icao: 'LIRF', name: 'Rome Fiumicino', center: 'LIRR_CTR', freqs: { ATIS: '120.450', DEL: '121.850', GND: '121.900', TWR: '118.700', APP: '125.100' } },
        { icao: 'LEMD', name: 'Madrid Barajas', center: 'LECM_CTR', freqs: { ATIS: '130.850', DEL: '121.955', GND: '121.700', TWR: '118.450', APP: '120.300' } },
        { icao: 'LSZH', name: 'Zurich Airport', center: 'LSAG_CTR', freqs: { ATIS: '128.525', DEL: '121.825', GND: '121.900', TWR: '118.100', APP: '120.375' } },
        { icao: 'EKCH', name: 'Copenhagen Kastrup', center: 'EKDK_CTR', freqs: { ATIS: '127.325', DEL: '121.850', GND: '121.900', TWR: '118.100', APP: '119.800' } },
        { icao: 'ENGM', name: 'Oslo Gardermoen', center: 'ENOS_CTR', freqs: { ATIS: '120.500', DEL: '121.775', GND: '121.900', TWR: '118.300', APP: '119.100' } },
        { icao: 'ESSA', name: 'Stockholm Arlanda', center: 'ESOS_CTR', freqs: { ATIS: '126.375', DEL: '121.925', GND: '121.750', TWR: '118.500', APP: '119.000' } },
        { icao: 'KJFK', name: 'New York JFK', center: 'ZNY_CTR', freqs: { ATIS: '115.400', DEL: '125.050', GND: '121.900', TWR: '119.100', APP: '123.900' } },
        { icao: 'KLAX', name: 'Los Angeles Intl', center: 'ZLA_CTR', freqs: { ATIS: '133.800', DEL: '121.650', GND: '121.650', TWR: '119.850', APP: '124.300' } },
        { icao: 'KATL', name: 'Atlanta Hartsfield-Jackson', center: 'ZTL_CTR', freqs: { ATIS: '135.000', DEL: '121.750', GND: '121.900', TWR: '119.100', APP: '119.500' } },
        { icao: 'KORD', name: 'Chicago O\'Hare', center: 'ZAU_CTR', freqs: { ATIS: '135.425', DEL: '121.600', GND: '121.900', TWR: '120.750', APP: '119.000' } },
        { icao: 'CYYZ', name: 'Toronto Pearson', center: 'CZYZ_CTR', freqs: { ATIS: '128.700', DEL: '121.700', GND: '121.900', TWR: '118.700', APP: '119.300' } },
        { icao: 'YSSY', name: 'Sydney Kingsford Smith', center: 'YSSY_CTR', freqs: { ATIS: '126.250', DEL: '121.9', GND: '121.7', TWR: '120.5', APP: '124.4' } },
        { icao: 'OMDB', name: 'Dubai Intl', center: 'OMAE_CTR', freqs: { ATIS: '122.450', DEL: '121.650', GND: '121.850', TWR: '119.550', APP: '124.900' } },
        { icao: 'VHHH', name: 'Hong Kong Intl', center: 'VHHK_CTR', freqs: { ATIS: '128.200', DEL: '121.8', GND: '121.6', TWR: '118.8', APP: '119.1' } }
    ];

    const fetchFlightBtn = document.getElementById('fetch-flight-btn');
    const departureIcaoInput = document.getElementById('departure-icao');
    const arrivalIcaoInput = document.getElementById('arrival-icao');
    const callsignInput = document.getElementById('callsign-input');
    const departureResultsDiv = document.getElementById('departure-results');
    const arrivalResultsDiv = document.getElementById('arrival-results');
    const topDownResultsDiv = document.getElementById('top-down-results');

    function generateAirportHtml(icao, vatsimData) {
        const airportInfo = airportDatabase.find(airport => airport.icao === icao);
        
        const onlineControllers = (vatsimData.controllers || []).filter(c => c.callsign.startsWith(icao) && !c.callsign.includes('_OBS'));
        const onlineAtis = (vatsimData.atis || []).filter(a => a.callsign.startsWith(icao));
        const allOnline = [...onlineControllers, ...onlineAtis];
        
        const name = airportInfo ? airportInfo.name : 'Unknown Airport';
        const center = airportInfo ? airportInfo.center : 'N/A';
        const standardFreqs = airportInfo ? airportInfo.freqs : {};

        let freqsHtml = '<ul>';
        let displayedFreqs = new Set();

        if (Object.keys(standardFreqs).length > 0) {
            for (const [type, freq] of Object.entries(standardFreqs)) {
                const onlineStation = allOnline.find(s => s.frequency === freq);
                const onlineBadge = onlineStation 
                    ? `<span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-emerald-600 bg-emerald-200">Online</span>` 
                    : '';
                const callsignInfo = onlineStation ? `<span class="text-sm text-gray-500 ml-2">(${onlineStation.callsign})</span>` : '';

                freqsHtml += `<li class="flex items-center">
                                <strong class="w-20">${type}:</strong> ${freq} ${onlineBadge} ${callsignInfo}
                              </li>`;
                if(onlineStation) displayedFreqs.add(onlineStation.callsign);
            }
        }
        
        allOnline.forEach(station => {
            if (!displayedFreqs.has(station.callsign)) {
                 const type = station.callsign.split('_').pop();
                 freqsHtml += `<li class="flex items-center">
                                <strong class="w-20">${type}:</strong> ${station.frequency} 
                                <span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-emerald-600 bg-emerald-200">Online</span>
                                <span class="text-sm text-gray-500 ml-2">(${station.callsign})</span>
                              </li>`;
            }
        });
        
        if (allOnline.length === 0 && !airportInfo) {
             return `<div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold text-gray-900">${icao}</h3>
                        <p class="mt-4">No live ATC was found for this ICAO and it is not in the local database.</p>
                     </div>`;
        }

        freqsHtml += `<li class="flex items-center"><strong class="w-20">UNICOM:</strong> 122.800</li></ul>`;

        return `
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-bold text-gray-900">${name} (${icao})</h3>
                <p class="mt-2 text-md text-gray-600">Responsible Center: <strong class="text-cyan-800">${center}</strong></p>
                <div class="mt-4 border-t pt-4">
                    <h4 class="text-lg font-semibold mb-2">Frequencies (Live Status):</h4>
                    <div class="space-y-1 text-gray-700">${freqsHtml}</div>
                </div>
            </div>`;
    }

    function analyzeTopDownServices(icao, vatsimData) {
        const controllers = (vatsimData.controllers || []).filter(c => c.callsign.startsWith(icao));
        const isOnline = {
            CTR: controllers.some(c => c.callsign.endsWith('_CTR')),
            APP: controllers.some(c => c.callsign.endsWith('_APP')),
            TWR: controllers.some(c => c.callsign.endsWith('_TWR')),
            GND: controllers.some(c => c.callsign.endsWith('_GND')),
            DEL: controllers.some(c => c.callsign.endsWith('_DEL'))
        };

        const getStation = (type) => controllers.find(c => c.callsign.endsWith(`_${type}`));
        
        const formatStationName = (station, fallbackName) => {
            if (!station || !station.text_atis || station.text_atis.length === 0) {
                return fallbackName;
            }
            const fullName = station.text_atis[0];
            console.log(`Full name for ${station.callsign}: ${fullName}`);
            const keywords = ['DELIVERY', 'GROUND', 'TOWER', 'APPROACH', 'RADAR', 'CENTER', 'CENTRE', 'ATIS'];
            // The full name could be Schiphol Delivery | Rapit wartaeejr aeraernga
            // I want to split it after matching the first keyword, not always | is used
            for (const keyword of keywords) {
                const regex = new RegExp(`\\b${keyword}\\b`, 'i');
                const match = fullName.match(regex);
                if (match) {
                    const namePart = fullName.substring(0, match.index + match[0].length).trim();
                    console.log(`Matched part for ${station.callsign}: ${namePart}`);
                    return namePart;
                }
            }
            

            return fallbackName;
        };
        
        let clearance = { name: "UNICOM", freq: "122.800", callsign: "UNICOM" };
        let ground = { name: "UNICOM", freq: "122.800", callsign: "UNICOM" };
        let tower = { name: "UNICOM", freq: "122.800", callsign: "UNICOM" };
        let approach = { name: "UNICOM", freq: "122.800", callsign: "UNICOM" };

        if (isOnline.CTR) {
            const station = getStation('CTR');
            clearance = ground = tower = approach = { name: formatStationName(station, 'Center'), freq: station.frequency, callsign: station.callsign };
        }
        if (isOnline.APP) {
            const station = getStation('APP');
            clearance = ground = tower = approach = { name: formatStationName(station, 'Approach'), freq: station.frequency, callsign: station.callsign };
        }
        if (isOnline.TWR) {
            const station = getStation('TWR');
            clearance = ground = tower = { name: formatStationName(station, 'Tower'), freq: station.frequency, callsign: station.callsign };
        }
        if (isOnline.GND) {
            const station = getStation('GND');
            clearance = ground = { name: formatStationName(station, 'Ground'), freq: station.frequency, callsign: station.callsign };
        }
        if (isOnline.DEL) {
            const station = getStation('DEL');
            clearance = { name: formatStationName(station, 'Delivery'), freq: station.frequency, callsign: station.callsign };
        }
        
        return { icao, clearance, ground, tower, approach };
    }
    
    function generateIfrData(callsign, dep, arr, depInfo, arrInfo) {
        if (!callsign || !dep || !arr || !depInfo || !arrInfo) return null;
        
        const depAirportName = depInfo.name.split(' ')[0];
        const arrAirportName = arrInfo.name;

        return [
            {
                title: "1. At the Gate: ATIS & Clearance",
                content: `
                    <p class="mb-4">First, get the airport's ATIS for weather and runway info. You must include the ATIS letter in your first call.</p>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.clearance.name}, ${callsign}, at stand 5, with information Bravo, request IFR clearance to ${arrAirportName}."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.clearance.name}):</strong> "${callsign}, cleared to ${arrInfo.icao} via the [SID/Departure Procedure], flight planned route. Initial climb [Altitude], departure frequency ${dep.approach.freq}, squawk [Code]."</div>
                    <div class="dialogue pilot-dialogue"><strong>Pilot (Readback):</strong> "Cleared to ${arrInfo.icao}, [SID/Departure], initial climb [Altitude], frequency ${dep.approach.freq}, squawk [Code], ${callsign}."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.clearance.name}):</strong> "${callsign}, readback correct. Contact ${depAirportName} ${dep.ground.name} on ${dep.ground.freq}."</div>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "Contact ${dep.ground.name} ${dep.ground.freq}, ${callsign}."</div>
                `
            },
            {
                title: "2. On the Apron: Pushback & Taxi",
                content: `
                    <p class="mb-4">After getting clearance and being told to contact Ground, you make your initial call to them to request movement.</p>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.ground.name}, ${callsign}, at stand 5 with information Bravo, request pushback and engine start."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.ground.name}):</strong> "${callsign}, push and start approved, face [Direction]."</div>
                    <p class="my-4">After pushback is complete:</p>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.ground.name}, ${callsign}, ready to taxi."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.ground.name}):</strong> "${callsign}, taxi to holding point [Holding Point] for runway [Runway] via taxiway [Taxiway(s)]."</div>
                `
            },
            {
                title: "3. At the Runway: Takeoff",
                content: `
                    <p class="mb-4">Ground will hand you off to Tower. Check in with Tower when ready for departure.</p>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.ground.name}):</strong> "${callsign}, contact ${dep.tower.name} on ${dep.tower.freq}."</div>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "Contacting ${dep.tower.name}, ${dep.tower.freq}, ${callsign}."</div>
                    <p class="my-4">On the new frequency:</p>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> " ${dep.tower.name}, ${callsign}, at holding point [Holding Point], ready for departure runway [Runway]."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.tower.name}):</strong> "${callsign}, wind [Direction] degrees at [Speed] knots, runway [Runway], cleared for takeoff."</div>
                `
            },
            {
                title: "4. In the Air: Departure",
                content: `
                    <p class="mb-4">Shortly after takeoff, Tower will hand you off to a radar controller.</p>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.tower.name}):</strong> "${callsign}, contact ${dep.approach.name} on ${dep.approach.freq}."</div>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "Contacting ${dep.approach.name}, ${dep.approach.freq}, ${callsign}."</div>
                    <p class="my-4">On the new frequency:</p>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> " ${dep.approach.name}, ${callsign}, passing [Altitude] feet, climbing [Cleared Altitude] feet."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${dep.approach.name}):</strong> "${callsign}, radar contact. Climb and maintain [Flight Level]."</div>
                `
            },
            {
                title: "5. Arrival: Descent & Approach",
                content: `
                    <p class="mb-4">As you near your destination, Approach control will issue descent instructions and clear you for an arrival.</p>
                    <div class="dialogue atc-dialogue"><strong>ATC (${arr.approach.name}):</strong> "${callsign}, fly heading [Heading]. Descend and maintain [Altitude] feet, QNH [QNH]. Expect vectors for the [Approach Type] runway [Runway] approach."</div>
                    <p class="my-4">Later, when aligned with the runway:</p>
                    <div class="dialogue atc-dialogue"><strong>ATC (${arr.approach.name}):</strong> "${callsign}, [Distance] miles from touchdown, turn right heading [Heading], cleared [Approach Type] runway [Runway] approach. Contact ${arrInfo.name.split(' ')[0]} ${arr.tower.name} on ${arr.tower.freq}."</div>
                `
            },
            {
                title: "6. Landing & Taxi to Gate",
                content: `
                    <p class="mb-4">Check in with Tower once established on final. After landing, vacate and contact Ground.</p>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${arr.tower.name}, ${callsign}, established on the [Approach Type] for runway [Runway]."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${arr.tower.name}):</strong> "${callsign}, wind [Direction] at [Speed] knots, runway [Runway], cleared to land."</div>
                    <p class="my-4">After landing and vacating:</p>
                    <div class="dialogue atc-dialogue"><strong>ATC (${arr.tower.name}):</strong> "${callsign}, runway vacated, contact ${arr.ground.name} on ${arr.ground.freq}."</div>
                    <p class="my-4">On the new frequency:</p>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${arr.ground.name}, ${callsign}, runway [Runway] vacated at taxiway [Taxiway], request taxi to the gate."</div>
                    <div class="dialogue atc-dialogue"><strong>ATC (${arr.ground.name}):</strong> "${callsign}, taxi to gate [Gate] via taxiway [Taxiway(s)]."</div>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "Taxiing to gate [Gate] via taxiway [Taxiway(s)], ${callsign}."</div>
                    <div class="my-4">Later, when parked:</div>
                    <div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${arr.ground.name}, ${callsign} is parked at gate [Gate], Have a nice day"</div>
                `
            }
        ];
    }

    function renderTopDownResults(depServices, arrServices) {
        const renderColumn = (services, type) => {
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-bold text-gray-900">${type}: ${services.icao}</h3>
                    <div class="mt-4 border-t pt-4 space-y-4">
                        <div>
                            <h4 class="font-semibold text-lg">IFR Clearance:</h4>
                            <p class="text-xl font-bold text-cyan-700">${services.clearance.name}</p>
                            <p class="text-gray-600">${services.clearance.callsign} &middot; ${services.clearance.freq}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-lg">Pushback & Taxi:</h4>
                            <p class="text-xl font-bold text-cyan-700">${services.ground.name}</p>
                            <p class="text-gray-600">${services.ground.callsign} &middot; ${services.ground.freq}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-lg">Takeoff / Landing:</h4>
                            <p class="text-xl font-bold text-cyan-700">${services.tower.name}</p>
                            <p class="text-gray-600">${services.tower.callsign} &middot; ${services.tower.freq}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-lg">Departure / Approach:</h4>
                            <p class="text-xl font-bold text-cyan-700">${services.approach.name}</p>
                            <p class="text-gray-600">${services.approach.callsign} &middot; ${services.approach.freq}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        topDownResultsDiv.innerHTML = renderColumn(depServices, 'Departure') + renderColumn(arrServices, 'Arrival');
    }

    async function lookupFlightPlanFrequencies() {
        const depIcao = departureIcaoInput.value.trim().toUpperCase();
        const arrIcao = arrivalIcaoInput.value.trim().toUpperCase();
        const callsign = callsignInput.value.trim() || "[Your Callsign]";

        if (!depIcao || !arrIcao) {
             departureResultsDiv.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md" role="alert"><p>Please enter both Departure and Arrival ICAO codes.</p></div>`;
             arrivalResultsDiv.innerHTML = '';
             topDownResultsDiv.innerHTML = '';
            return;
        }

        departureResultsDiv.innerHTML = `<div class="loader"></div>`;
        arrivalResultsDiv.innerHTML = `<div class="loader"></div>`;
        topDownResultsDiv.innerHTML = `<div class="md:col-span-2"><div class="loader"></div></div>`;


        try {
            const response = await fetch(`https://data.vatsim.net/v3/vatsim-data.json`);
            if (!response.ok) {
                 throw new Error(`Network response was not ok, status: ${response.status}`);
            }
            const vatsimData = await response.json();

            if (!vatsimData || !vatsimData.controllers) {
                throw new Error("Invalid or incomplete data received from VATSIM API.");
            }
            
            const depAirportInfo = airportDatabase.find(airport => airport.icao === depIcao);
            const arrAirportInfo = airportDatabase.find(airport => airport.icao === arrIcao);
            
            departureResultsDiv.innerHTML = generateAirportHtml(depIcao, vatsimData);
            arrivalResultsDiv.innerHTML = generateAirportHtml(arrIcao, vatsimData);

            const depServices = analyzeTopDownServices(depIcao, vatsimData);
            const arrServices = analyzeTopDownServices(arrIcao, vatsimData);
            renderTopDownResults(depServices, arrServices);
            
            const ifrScriptData = generateIfrData(callsign, depServices, arrServices, depAirportInfo, arrAirportInfo);
            createAccordion('ifr-accordion', ifrScriptData);


        } catch (error) {
            let userMessage = `Could not fetch live data from VATSIM. Please try again later.`;
            if (error.message.includes('incomplete') || error.name === 'TypeError' && error.message.includes('cancelled')) {
                userMessage = `The connection to the VATSIM data feed was interrupted. This can happen with large data files on unstable connections. Please try again.`
            }
            const errorHtml = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                    <p class="font-bold">Network Error</p>
                    <p>${userMessage}</p>
                </div>`;
            departureResultsDiv.innerHTML = errorHtml;
            arrivalResultsDiv.innerHTML = '';
            topDownResultsDiv.innerHTML = `<div class="md:col-span-2">${errorHtml}</div>`;
        }
    }
    
    fetchFlightBtn.addEventListener('click', lookupFlightPlanFrequencies);
});
</script>

</body>
</html>
