<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Guide to VATSIM Communication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            background-color: #f5f5f4; /* stone-100 */
            color: #27272a; /* zinc-800 */
            font-family: 'Inter', sans-serif;
        }
        .dark body {
            background-color: #18181b; /* zinc-900 */
            color: #d4d4d8; /* zinc-300 */
        }
        @import url('https://rsms.me/inter/inter.css');
        .nav-button {
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid transparent;
        }
        .nav-button.active {
            border-bottom-color: #0891b2; /* cyan-600 */
            color: #0e7490; /* cyan-700 */
        }
        .dark .nav-button.active {
            color: #67e8f9; /* cyan-300 */
        }
        .nav-button:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .dark .nav-button:hover {
            background-color: #27272a; /* zinc-800 */
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .accordion-button {
            transition: background-color 0.2s;
        }
        .dialogue {
            border-left: 3px solid;
            padding-left: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .pilot-dialogue {
            border-color: #0891b2; /* cyan-600 */
        }
        .atc-dialogue {
            border-color: #be123c; /* rose-700 */
        }
        .loader {
            border: 4px solid #3f3f46; /* zinc-700 */
            border-top: 4px solid #0891b2; /* cyan-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pinging {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen">
        <header class="bg-white dark:bg-zinc-800 shadow-sm">
            <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl font-bold tracking-tight text-gray-900 dark:text-gray-100 sm:text-5xl">Interactive Guide to VATSIM Communication</h1>
                <p class="mt-4 text-xl text-gray-600 dark:text-gray-400">Your co-pilot for mastering radio calls and procedures on the network.</p>
                <div id="flight-plan-inputs" class="mt-6 max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <input type="text" id="departure-icao" class="p-3 border border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Departure ICAO (e.g., EHAM)">
                    <input type="text" id="arrival-icao" class="p-3 border border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Arrival ICAO (e.g., EGLL)">
                    <input type="text" id="callsign-input" class="p-3 border border-gray-300 dark:border-zinc-600 bg-white dark:bg-zinc-700 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Callsign (e.g., Vueling 016)">
                    <button id="fetch-flight-btn" class="sm:col-span-3 bg-cyan-600 text-white font-bold py-3 px-6 rounded-md hover:bg-cyan-700 transition-colors">Fetch Frequencies & Build Script</button>
                </div>
                 <div id="last-updated-container" class="mt-4 text-sm text-gray-500 dark:text-gray-400"></div>
            </div>
        </header>

        <main class="py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                 <div id="flight-results-container" class="mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:items-stretch">
                        <div id="departure-results" class="flex"></div>
                        <div id="arrival-results" class="flex"></div>
                    </div>
                </div>

                <nav id="main-nav" class="flex flex-wrap justify-center border-b border-gray-300 dark:border-zinc-700 mb-8">
                    <button data-target="prepare" class="nav-button active text-lg font-medium py-4 px-6">1. Get Prepared</button>
                    <button data-target="who-to-call" class="nav-button text-lg font-medium py-4 px-6">2. Who Do I Call? (Live)</button>
                    <button data-target="flight-phraseology" class="nav-button text-lg font-medium py-4 px-6">3. Flight Phraseology (Live)</button>
                    <button data-target="reference" class="nav-button text-lg font-medium py-4 px-6">4. Quick Reference</button>
                </nav>

                <div id="content-container">
                    <section id="prepare" class="content-section active">
                        <div class="text-center mb-12">
                            <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Foundations of Radio Discipline</h2>
                            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Success on the network starts before you connect. Strong preparation is the key to minimizing stress and ensuring smooth communication for everyone.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-3 text-cyan-800 dark:text-cyan-400">‚úàÔ∏è Aircraft Familiarity</h3>
                                <p class="text-gray-700 dark:text-gray-300">This is the most critical step. You must be comfortable with your aircraft's systems, especially the autopilot and FMS, *before* adding ATC. Controllers issue instructions with the expectation you can comply quickly. Practice offline until you can confidently manage your aircraft's speed, heading, and altitude without hesitation.</p>
                            </div>
                            <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-3 text-cyan-800 dark:text-cyan-400">üó∫Ô∏è Flight Plan & Charts</h3>
                                <p class="text-gray-700 dark:text-gray-300">Always file a valid flight plan before connecting. Have all necessary charts for your route: Airport Diagrams, SIDs, STARs, and En-route charts. An instruction like "Taxi to holding point Alpha 1 via Kilo" is impossible without the airport diagram. Not having charts creates unnecessary delays for you and the controller.</p>
                            </div>
                            <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-3 text-cyan-800 dark:text-cyan-400">üìú The Rules of the Radio</h3>
                                <p class="text-gray-700 dark:text-gray-300"><strong class="block mb-1">Listen before you speak.</strong> This prevents cutting someone off. Your first call should almost always follow this structure: <strong class="text-cyan-900 dark:text-cyan-300">1. Who you're calling, 2. Who you are, 3. What you want.</strong> Example: "Luton Ground, Easy 123, request pushback."</p>
                            </div>
                        </div>
                    </section>

                    <section id="who-to-call" class="content-section">
                        <div class="text-center mb-12">
                            <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Live Top-Down Service Guide</h2>
                            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Based on the live VATSIM data for your flight plan, here is the correct controller to contact for each phase of flight.</p>
                        </div>
                        <div id="top-down-results" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div class="bg-white dark:bg-zinc-800 p-8 rounded-lg shadow-lg text-center md:col-span-2">
                                <p class="text-gray-600 dark:text-gray-400">Enter a departure, arrival ICAO, and callsign in the header and click "Fetch Frequencies" to see live controller information here.</p>
                            </div>
                        </div>
                    </section>

                    <section id="flight-phraseology" class="content-section">
                        <div class="text-center mb-12">
                             <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Live Flight Phraseology</h2>
                             <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">This is a personalized walkthrough of your flight using your callsign and live ATC data, blending IFR and UNICOM calls as needed.</p>
                        </div>
                        <div class="space-y-2" id="flight-phraseology-accordion">
                           <div class="bg-white dark:bg-zinc-800 p-8 rounded-lg shadow-lg text-center">
                                <p class="text-gray-600 dark:text-gray-400">Enter your flight details in the header and click "Fetch Frequencies" to generate your personalized script.</p>
                            </div>
                        </div>
                    </section>

                    <section id="reference" class="content-section">
                         <div class="text-center mb-12">
                             <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Quick Reference</h2>
                             <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Essential information at your fingertips. Use this for the phonetic alphabet and how to handle common situations.</p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-4 text-cyan-800 dark:text-cyan-400">ICAO Phonetic Alphabet & Numbers</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-slate-100 dark:bg-zinc-700">
                                            <tr>
                                                <th class="p-2">Letter</th><th class="p-2">Code</th><th>Pronunciation</th>
                                                <th class="p-2">Num</th><th class="p-2">Pronunciation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="phonetic-table-body">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow">
                                <h3 class="text-2xl font-semibold mb-4 text-cyan-800 dark:text-cyan-400">Handling the Unexpected</h3>
                                <div class="space-y-4">
                                    <div>
                                        <h4 class="font-bold text-lg">Instruction Unclear?</h4>
                                        <p class="text-gray-700 dark:text-gray-300">Never guess. The most important phrase is <strong class="text-rose-700 dark:text-rose-500">"Say again."</strong> Controllers would much rather repeat themselves than have you perform a wrong action. Simply say: <code class="bg-gray-200 dark:bg-zinc-700 dark:text-gray-300 p-1 rounded">"Say again for [Your Callsign]."</code></p>
                                    </div>
                                     <div>
                                        <h4 class="font-bold text-lg">Made a Mistake?</h4>
                                        <p class="text-gray-700 dark:text-gray-300">It happens! VATSIM is a learning environment. The controller will correct you. Acknowledge the correction, comply with the new instruction, and move on. Don't panic.</p>
                                    </div>
                                     <div>
                                        <h4 class="font-bold text-lg">Simulated Emergency</h4>
                                        <p class="text-gray-700 dark:text-gray-300">Declare it with <strong class="text-rose-700 dark:text-rose-500">"Mayday, Mayday, Mayday."</strong> State your callsign, position, the nature of the emergency, and your intentions. Squawk 7700. Be aware controllers can deny emergency requests if traffic prevents them from accommodating. <strong class="font-bold">Never use squawk codes 7500 or 7600.</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // Dark Mode Logic (no changes here)
    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark')
    }

    // Navigation and Accordion Logic (no changes here)
    const mainNav = document.getElementById('main-nav');
    const contentContainer = document.getElementById('content-container');
    mainNav.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const targetId = e.target.dataset.target;
            mainNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            contentContainer.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                if (section.id === targetId) {
                    section.classList.add('active');
                }
            });
        }
    });
    
    // Accordion functionality (no changes here)
    function createAccordion(containerId, data) {
        const container = document.getElementById(containerId);
        if (!container || !data) return;
        container.innerHTML = data.map((item, index) => {
            const isAlwaysOpen = item.title.includes('‚ö†Ô∏è Center Controller Alert');
            const buttonClass = isAlwaysOpen ? 'accordion-button flex items-center justify-between w-full p-5 font-medium text-left text-gray-700 dark:text-gray-300 bg-blue-50 dark:bg-blue-900/20 focus:outline-none cursor-default' : 'accordion-button flex items-center justify-between w-full p-5 font-medium text-left text-gray-700 dark:text-gray-300 hover:bg-slate-100 dark:hover:bg-zinc-700 focus:outline-none';
            const contentClass = isAlwaysOpen ? 'p-5 border-t border-gray-200 dark:border-zinc-700' : 'hidden p-5 border-t border-gray-200 dark:border-zinc-700';
            const contentStyle = isAlwaysOpen ? 'max-height: none; overflow: visible;' : 'max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out;';
            const iconRotation = isAlwaysOpen ? 'rotate-180' : '';
            const iconStyle = isAlwaysOpen ? 'display: none;' : '';
            
            return `
            <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-sm">
                <h2>
                    <button type="button" class="${buttonClass}" data-accordion-target="accordion-body-${containerId}-${index}" ${isAlwaysOpen ? 'disabled' : ''}>
                        <span>${item.title}</span>
                        <svg class="w-6 h-6 shrink-0 transform ${iconRotation}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style="${iconStyle}"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </h2>
                <div id="accordion-body-${containerId}-${index}" class="${contentClass}" style="${contentStyle}">${item.content}</div>
            </div>
        `;
        }).join('');

        container.addEventListener('click', e => {
            const button = e.target.closest('.accordion-button');
            if (!button || button.disabled) return;
            const content = document.getElementById(button.dataset.accordionTarget);
            const icon = button.querySelector('svg');
            content.classList.toggle('hidden');
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = '0px';
                icon.classList.remove('rotate-180');
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.classList.add('rotate-180');
            }
        });
    }
    
    // Phonetic Alphabet Data and Table generation (no changes here)
    const phoneticData = [
        ['A', 'Alfa', 'AL-FAH', '0', 'ZE-RO'], ['B', 'Bravo', 'BRAH-VOH', '1', 'WUN'],
        ['C', 'Charlie', 'CHAR-LEE', '2', 'TOO'], ['D', 'Delta', 'DELL-TAH', '3', 'TREE'],
        ['E', 'Echo', 'ECK-OH', '4', 'FOW-ER'], ['F', 'Foxtrot', 'FOKS-TROT', '5', 'FIFE'],
        ['G', 'Golf', 'GOLF', '6', 'SIX'], ['H', 'Hotel', 'HOH-TEL', '7', 'SEV-EN'],
        ['I', 'India', 'IN-DEE-AH', '8', 'AIT'], ['J', 'Juliett', 'JEW-LEE-ETT', '9', 'NIN-ER'],
        ['K', 'Kilo', 'KEY-LOH', '', ''], ['L', 'Lima', 'LEE-MAH', '', ''],
        ['M', 'Mike', 'MIKE', '', ''], ['N', 'November', 'NO-VEM-BER', '', ''],
        ['O', 'Oscar', 'OSS-CAH', '', ''], ['P', 'Papa', 'PAH-PAH', '', ''],
        ['Q', 'Quebec', 'KEH-BECK', '', ''], ['R', 'Romeo', 'ROW-ME-OH', '', ''],
        ['S', 'Sierra', 'SEE-AIR-RAH', '', ''], ['T', 'Tango', 'TANG-GO', '', ''],
        ['U', 'Uniform', 'YOU-NEE-FORM', '', ''], ['V', 'Victor', 'VIK-TAH', '', ''],
        ['W', 'Whiskey', 'WISS-KEY', '', ''], ['X', 'X-ray', 'ECKS-RAY', '', ''],
        ['Y', 'Yankee', 'YANG-KEY', '', ''], ['Z', 'Zulu', 'ZOO-LOO', '', '']
    ];
    const phoneticTableBody = document.getElementById('phonetic-table-body');
    phoneticTableBody.innerHTML = phoneticData.map(row => `
        <tr class="border-b dark:border-zinc-700">
            <td class="p-2 font-bold">${row[0]}</td><td class="p-2">${row[1]}</td>
            <td class="p-2 text-sm text-gray-600 dark:text-gray-400">${row[2]}</td>
            <td class="p-2 font-bold">${row[3]}</td><td class="p-2 text-sm text-gray-600 dark:text-gray-400">${row[4]}</td>
        </tr>
    `).join('');

    // ---- NEW AND MODIFIED CODE STARTS HERE ----

    const fetchFlightBtn = document.getElementById('fetch-flight-btn');
    const departureIcaoInput = document.getElementById('departure-icao');
    const arrivalIcaoInput = document.getElementById('arrival-icao');
    const callsignInput = document.getElementById('callsign-input');
    const departureResultsDiv = document.getElementById('departure-results');
    const arrivalResultsDiv = document.getElementById('arrival-results');
    const topDownResultsDiv = document.getElementById('top-down-results');
    const lastUpdatedContainer = document.getElementById('last-updated-container');
    let refreshInterval = null;

    // A variable to hold our airport data once it's loaded.
    let airportsData = null;

    /**
     * NEW: Fetches and caches airport data from a JSON file.
     */
    async function getAirportsData(jsonUrl) {
        const CACHE_KEY = 'airportsData';
        const CACHE_DURATION_MS = 1 * 60 * 60 * 1000; // 24 hours

        const cachedItem = localStorage.getItem(CACHE_KEY);

        if (cachedItem) {
            const { timestamp, data } = JSON.parse(cachedItem);
            if ((Date.now() - timestamp) < CACHE_DURATION_MS) {
                console.log("Success: Returning data from cache.");
                return data;
            } else {
                console.log("Info: Cache is expired. Fetching new data.");
            }
        }
        
        try {
            console.log("Info: Fetching new airport data from network...");
            const response = await fetch(jsonUrl);
            if (!response.ok) throw new Error(`Network response was not ok`);
            const freshData = await response.json();
            const newCacheItem = { timestamp: Date.now(), data: freshData };
            localStorage.setItem(CACHE_KEY, JSON.stringify(newCacheItem));
            console.log("Success: Fetched and cached new data.");
            return freshData;
        } catch (error) {
            console.error("Failed to fetch or cache airport data:", error);
            return {};
        }
    }

    /**
     * MODIFIED: Looks up an airport name using the loaded data.
     */
    function getAirportName(icao) {
        if (!airportsData) {
            console.error("Airport data not loaded yet!");
            return icao; // Return ICAO as a fallback if data isn't ready
        }
        // Return the name from the data, or the ICAO itself if not found.
        return airportsData[icao] && airportsData[icao].name ? airportsData[icao].name : icao;
    }

    function getAirportControl(icao, vatsimData = null) {
        if (!airportsData) {
            console.error("Airport data not loaded yet!");
            return null; // Return null if data isn't ready
        }
        
        const airportData = airportsData[icao];
        if (!airportData || !airportData.center_name || !airportData.center_callsign) {
            return null;
        }
        
        // If VATSIM data is provided, check if the center controller is actually online
        if (vatsimData && vatsimData.controllers) {
            // Find the center controller that matches the callsign and is not an observer
            const centerOnline = vatsimData.controllers.find(c => 
                c.callsign.includes(airportData.center_callsign) && !c.callsign.includes('_OBS')
            );

            if (centerOnline) {
                return {
                    name: airportData.center_name,
                    callsign: airportData.center_callsign,
                    frequency: centerOnline.frequency,
                    online: true
                };
            } else {
                return {
                    name: airportData.center_name,
                    callsign: airportData.center_callsign,
                    frequency: null,
                    online: false
                };
            }
        }
        
        // Fallback for when no VATSIM data is provided
        return {
            name: airportData.center_name,
            callsign: airportData.center_callsign,
            frequency: null,
            online: false
        };
    }

    /**
     * MODIFIED: Gets dynamic info and uses getAirportName to find the name.
     */
    function getDynamicAirportInfo(icao, vatsimData) {
        const controllers = (vatsimData.controllers || []).filter(c => c.callsign.startsWith(icao) && !c.callsign.includes('_OBS'));
        const atis = (vatsimData.atis || []).find(a => a.callsign.startsWith(icao));
        const name = getAirportName(icao);
        const center = getAirportControl(icao, vatsimData);
        
        return { icao, name, center, controllers, atis };
    }

    // generateAirportHtml, analyzeTopDownServices, and other functions remain the same...
    // They will now automatically work because getDynamicAirportInfo provides the correct name.
    
    function generateAirportHtml(airportInfo) {
        const { icao, name, center, controllers, atis } = airportInfo;
        const allOnline = [...controllers, ...(atis ? [atis] : [])];
        
        let freqsHtml = '<ul>';
        if (allOnline.length === 0) {
            freqsHtml += '<li>No active ATC was found for this ICAO.</li>';
        } else {
            allOnline.forEach(station => {
                const type = station.callsign.split('_').pop();
                freqsHtml += `<li class="flex items-center"><span class="w-20 font-semibold text-gray-500 dark:text-gray-400">${type}:</span> ${station.frequency} <span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-emerald-600 bg-emerald-200">Online</span><span class="text-sm text-gray-500 dark:text-gray-400 ml-2">(${station.callsign})</span></li>`;
            });
        }
        freqsHtml += `<li class="flex items-center"><span class="w-20 font-semibold text-gray-500 dark:text-gray-400">UNICOM:</span> 122.800</li></ul>`;
        
        let centerHtml = '';
        if (center) {
            if (center.online) {
                centerHtml = `<h4 class="text-gray-600 dark:text-gray-400">${center.name} (${center.callsign}) is online at ${center.frequency}</h4>`;
            } else {
                centerHtml = `<h4 class="text-gray-600 dark:text-gray-400">${center.name} (${center.callsign}) is offline</h4>`;
            }
        } else {
            centerHtml = `<div class="h-6"></div>`;
        }
        
        return `<div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-md flex-1 h-full"><h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${name} (${icao})</h3>${centerHtml}<div class="mt-4 border-t dark:border-zinc-700 pt-4"><h4 class="text-lg font-semibold mb-2">Frequencies (Live Status):</h4><div class="space-y-1 text-gray-700 dark:text-gray-300">${freqsHtml}</div></div></div>`;
    }

    function analyzeTopDownServices(airportInfo) {
        const { icao, controllers, center } = airportInfo;
        const getStation = (type) => controllers.find(c => c.callsign.endsWith(`_${type}`));
        const stations = { DEL: getStation('DEL'), GND: getStation('GND'), TWR: getStation('TWR'), APP: getStation('APP'), CTR: getStation('CTR') };
        const formatStationName = (station, fallbackName) => {
            if (!station || !station.text_atis || station.text_atis.length === 0) return fallbackName;
            const fullName = station.text_atis[0];
            const keywords = ['DELIVERY', 'GROUND', 'TOWER', 'APPROACH', 'RADAR', 'CENTER', 'CENTRE'];
            for (const keyword of keywords) {
                const regex = new RegExp(`\\b${keyword}\\b`, 'i'), match = fullName.match(regex);
                if (match) return fullName.substring(0, match.index + match[0].length).trim();
            }
            return fallbackName;
        };
        
        const unicomStation = { name: "UNICOM", freq: "122.800", callsign: "UNICOM" };
        
        // Create center station object if center is online
        const centerStation = center && center.online ? 
            { name: center.name, freq: center.frequency, callsign: center.callsign } : 
            unicomStation;
        
        const finalServices = { clearance: centerStation, ground: centerStation, tower: centerStation, approach: centerStation };

        // Apply top-down hierarchy - each online station overrides the services below it
        if (stations.CTR) { const s = stations.CTR; finalServices.approach = finalServices.tower = finalServices.ground = finalServices.clearance = { name: formatStationName(s, 'Center'), freq: s.frequency, callsign: s.callsign }; }
        if (stations.APP) { const s = stations.APP; finalServices.approach = finalServices.tower = finalServices.ground = finalServices.clearance = { name: formatStationName(s, 'Approach'), freq: s.frequency, callsign: s.callsign }; }
        if (stations.TWR) { const s = stations.TWR; finalServices.tower = finalServices.ground = finalServices.clearance = { name: formatStationName(s, 'Tower'), freq: s.frequency, callsign: s.callsign }; }
        if (stations.GND) { const s = stations.GND; finalServices.ground = finalServices.clearance = { name: formatStationName(s, 'Ground'), freq: s.frequency, callsign: s.callsign }; }
        if (stations.DEL) { const s = stations.DEL; finalServices.clearance = { name: formatStationName(s, 'Delivery'), freq: s.frequency, callsign: s.callsign }; }
        
        return { icao, name: airportInfo.name, ...finalServices };
    }
    
    function generateFlightPhraseology(callsign, dep, arr) {
       if (!callsign || !dep || !arr ) return null;
       const isUnicom = (station) => station.name === 'UNICOM';
       
       // Check if any center controllers are online
       const depCenterOnline = dep.center && dep.center.online;
       const arrCenterOnline = arr.center && arr.center.online;
       const anyCenterOnline = depCenterOnline || arrCenterOnline;
       let script = [];
       
       // Add disclaimer if any center is online
       if (anyCenterOnline) {
           let centerInfo = '';
           if (depCenterOnline && arrCenterOnline && dep.center.callsign === arr.center.callsign) {
               centerInfo = `<strong>${dep.center.name} (${dep.center.callsign})</strong> is online at <strong>${dep.center.frequency}</strong>`;
           } else {
               if (depCenterOnline) {
                   centerInfo += `<strong>${dep.center.name} (${dep.center.callsign})</strong> is online at <strong>${dep.center.frequency}</strong>`;
               }
               if (arrCenterOnline && dep.center.callsign !== arr.center.callsign) {
                   if (centerInfo) centerInfo += ' and ';
                   centerInfo += `<strong>${arr.center.name} (${arr.center.callsign})</strong> is online at <strong>${arr.center.frequency}</strong>`;
               }
           }
           
           script.push({
               title: "‚ö†Ô∏è Center Controller Alert",
               content: `<div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400 p-4 mb-4"><p class="mb-2"><strong>Important:</strong> ${centerInfo}.</p><p>Center controllers manage large airspace regions and may contact you during cruise flight for traffic separation, altitude changes, or routing amendments. Monitor their frequency during your flight and be ready to respond to calls directed at your aircraft.</p></div>`
           });
       }
       
       script = script.concat([
           { title: "1. At the Gate: Clearance", content: isUnicom(dep.clearance) ? `<p class="mb-4">No Clearance Delivery is online. Announce intentions on UNICOM.</p><div class="dialogue pilot-dialogue"><strong>Pilot to UNICOM (122.800):</strong> "${dep.name} Traffic, ${callsign}, at stand 5, pushing back for departure to ${arr.name}."</div>` : `<p class="mb-4">First, get the airport's ATIS for weather and runway info. You must include the ATIS letter in your first call.</p><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.clearance.name}, ${callsign}, at stand 5, with information Bravo, request IFR clearance to ${arr.name}."</div><div class="dialogue atc-dialogue"><strong>ATC (${dep.clearance.name}):</strong> "${callsign}, cleared to ${arr.icao} via the [SID/Departure Procedure], flight planned route. Initial climb [Altitude], departure frequency ${dep.approach.freq}, squawk [Code]."</div>`},
           { title: "2. On the Apron: Taxi", content: isUnicom(dep.ground) ? `<p class="mb-4">No Ground controller is online. Announce taxi on UNICOM.</p><div class="dialogue pilot-dialogue"><strong>Pilot to UNICOM (122.800):</strong> "${dep.name} Traffic, ${callsign}, taxiing to runway [Runway]."</div>` : `<p class="mb-4">After getting clearance and being told to contact Ground, you make your initial call to them to request movement.</p><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.ground.name}, ${callsign}, at stand 5 with information Bravo, request taxi."</div><div class="dialogue atc-dialogue"><strong>ATC (${dep.ground.name}):</strong> "${callsign}, taxi to holding point [Holding Point] for runway [Runway] via taxiway [Taxiway(s)]."</div>`},
           { title: "3. At the Runway: Takeoff", content: isUnicom(dep.tower) ? `<p class="mb-4">No Tower controller is online. Announce takeoff on UNICOM.</p><div class="dialogue pilot-dialogue"><strong>Pilot to UNICOM (122.800):</strong> "${dep.name} Traffic, ${callsign}, departing runway [Runway]."</div>` : `<p class="mb-4">Ground will hand you off to Tower. Check in with Tower when ready for departure.</p><div class="dialogue atc-dialogue"><strong>ATC (${dep.ground.name}):</strong> "${callsign}, contact ${dep.tower.name} on ${dep.tower.freq}."</div><p class="my-4">On the new frequency:</p><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.tower.name}, ${callsign}, at holding point [Holding Point], ready for departure runway [Runway]."</div><div class="dialogue atc-dialogue"><strong>ATC (${dep.tower.name}):</strong> "${callsign}, wind [Direction] degrees at [Speed] knots, runway [Runway], cleared for takeoff."</div>`}
       ]);
       
       // Add departure section with center info if applicable
       let departureContent = '';
       if (isUnicom(dep.approach)) {
           departureContent = `<p class="mb-4">No Departure controller is online. Monitor UNICOM and fly your cleared route.</p>`;
           if (depCenterOnline) {
               departureContent += `<p class="mb-4"><strong>Center Controller Online:</strong> ${dep.center.name} may contact you once airborne for traffic management.</p><div class="dialogue atc-dialogue"><strong>Possible ATC (${dep.center.name}):</strong> "${callsign}, contact ${dep.center.name} on ${dep.center.frequency}."</div><p class="my-4">If contacted by Center:</p><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.center.name}, ${callsign}, level [Altitude] feet."</div>`;
           }
       } else {
           departureContent = `<p class="mb-4">Shortly after takeoff, Tower will hand you off to a radar controller.</p><div class="dialogue atc-dialogue"><strong>ATC (${dep.tower.name}):</strong> "${callsign}, contact ${dep.approach.name} on ${dep.approach.freq}."</div><p class="my-4">On the new frequency:</p><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.approach.name}, ${callsign}, passing [Altitude] feet, climbing [Cleared Altitude] feet."</div><div class="dialogue atc-dialogue"><strong>ATC (${dep.approach.name}):</strong> "${callsign}, radar contact. Climb and maintain [Flight Level]."</div>`;
           if (depCenterOnline) {
               departureContent += `<p class="my-4">During cruise, you may be handed off to Center:</p><div class="dialogue atc-dialogue"><strong>ATC (${dep.approach.name}):</strong> "${callsign}, contact ${dep.center.name} on ${dep.center.frequency}."</div><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${dep.center.name}, ${callsign}, level [Flight Level]."</div>`;
           }
       }
       
       script.push({ title: "4. In the Air: Departure", content: departureContent });
       
       // Add arrival section with center info if applicable
       let arrivalContent = '';
       if (isUnicom(arr.approach)) {
           arrivalContent = `<p class="mb-4">No Approach controller is online. Announce your position and intentions on UNICOM.</p><div class="dialogue pilot-dialogue"><strong>Pilot to UNICOM (122.800):</strong> "${arr.name} Traffic, ${callsign}, 15 miles to the [Direction] at [Altitude] feet, inbound for the [Approach Type] runway [Runway]."</div>`;
           if (arrCenterOnline) {
               arrivalContent += `<p class="mb-4"><strong>Center Controller Online:</strong> ${arr.center.name} may provide descent instructions as you approach.</p><div class="dialogue atc-dialogue"><strong>Possible ATC (${arr.center.name}):</strong> "${callsign}, descend and maintain [Altitude] feet, QNH [QNH]."</div>`;
           }
       } else {
           arrivalContent = `<p class="mb-4">As you near your destination, Approach control will issue descent instructions and clear you for an arrival.</p><div class="dialogue atc-dialogue"><strong>ATC (${arr.approach.name}):</strong> "${callsign}, fly heading [Heading]. Descend and maintain [Altitude] feet, QNH [QNH]. Expect vectors for the [Approach Type] runway [Runway] approach."</div>`;
           if (arrCenterOnline && dep.center.callsign !== arr.center.callsign) {
               arrivalContent += `<p class="my-4">You may be handed off to the arrival center first:</p><div class="dialogue atc-dialogue"><strong>ATC (Center):</strong> "${callsign}, contact ${arr.center.name} on ${arr.center.frequency}."</div><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${arr.center.name}, ${callsign}, level [Flight Level], descending to [Altitude] feet."</div>`;
           }
       }
       
       script.push({ title: "5. Arrival: Descent & Approach", content: arrivalContent });
       
       script.push({ title: "6. Landing & Taxi to Gate", content: isUnicom(arr.tower) ? `<p class="mb-4">No Tower controller is online. Announce your final approach and landing on UNICOM.</p><div class="dialogue pilot-dialogue"><strong>Pilot to UNICOM (122.800):</strong> "${arr.name} Traffic, ${callsign}, on final for runway [Runway]."</div><p class="my-4">After landing and vacating:</p><div class="dialogue pilot-dialogue"><strong>Pilot to UNICOM (122.800):</strong> "${arr.name} Traffic, ${callsign}, runway [Runway] vacated."</div>` : `<p class="mb-4">Check in with Tower once established on final. After landing, vacate and contact Ground.</p><div class="dialogue pilot-dialogue"><strong>Pilot:</strong> "${arr.tower.name}, ${callsign}, established on the [Approach Type] for runway [Runway]."</div><div class="dialogue atc-dialogue"><strong>ATC (${arr.tower.name}):</strong> "${callsign}, wind [Direction] at [Speed] knots, runway [Runway], cleared to land."</div><p class="my-4">After landing and vacating:</p><div class="dialogue atc-dialogue"><strong>ATC (${arr.tower.name}):</strong> "${callsign}, runway vacated, contact ${arr.ground.name} on ${arr.ground.freq}."</div>`});
       
       return script;
    }
    
    function renderTopDownResults(depServices, arrServices) {
        const renderColumn = (services, type) => `<div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-md"><h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${type}: ${services.icao}</h3><div class="mt-4 border-t dark:border-zinc-700 pt-4 space-y-4"><div><h4 class="font-semibold text-lg">IFR Clearance:</h4><p class="text-xl font-bold text-cyan-700 dark:text-cyan-400">${services.clearance.name}</p><p class="text-gray-600 dark:text-gray-400">${services.clearance.callsign} &middot; ${services.clearance.freq}</p></div><div><h4 class="font-semibold text-lg">Pushback & Taxi:</h4><p class="text-xl font-bold text-cyan-700 dark:text-cyan-400">${services.ground.name}</p><p class="text-gray-600 dark:text-gray-400">${services.ground.callsign} &middot; ${services.ground.freq}</p></div><div><h4 class="font-semibold text-lg">Takeoff / Landing:</h4><p class="text-xl font-bold text-cyan-700 dark:text-cyan-400">${services.tower.name}</p><p class="text-gray-600 dark:text-gray-400">${services.tower.callsign} &middot; ${services.tower.freq}</p></div><div><h4 class="font-semibold text-lg">Departure / Approach:</h4><p class="text-xl font-bold text-cyan-700 dark:text-cyan-400">${services.approach.name}</p><p class="text-gray-600 dark:text-gray-400">${services.approach.callsign} &middot; ${services.approach.freq}</p></div></div></div>`;
        topDownResultsDiv.innerHTML = renderColumn(depServices, 'Departure') + renderColumn(arrServices, 'Arrival');
    }

    /**
     * MODIFIED: The main function that fetches all data and updates the UI.
     */
    async function lookupFlightPlanFrequencies(isRefresh = false) {
        const depIcao = departureIcaoInput.value.trim().toUpperCase();
        const arrIcao = arrivalIcaoInput.value.trim().toUpperCase();
        const callsign = callsignInput.value.trim() || "[Your Callsign]";

        if (!depIcao || !arrIcao) {
             if(!isRefresh) {
                 departureResultsDiv.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md" role="alert"><p>Please enter both Departure and Arrival ICAO codes.</p></div>`;
                 arrivalResultsDiv.innerHTML = '';
                 topDownResultsDiv.innerHTML = '';
             }
            return;
        }
        
        if(!isRefresh){
            departureResultsDiv.innerHTML = `<div class="loader"></div>`;
            arrivalResultsDiv.innerHTML = `<div class="loader"></div>`;
            topDownResultsDiv.innerHTML = `<div class="md:col-span-2"><div class="loader"></div></div>`;
        }
        lastUpdatedContainer.innerHTML = `<span class="pinging">Pinging VATSIM & Airport DB...</span>`;

        try {
            // --- MODIFICATION: Load airport data if it's not already loaded ---
            if (!airportsData) {
                airportsData = await getAirportsData('https://promotheux.github.io/vatsim-helper/airports.json');
            }

            const response = await fetch(`https://data.vatsim.net/v3/vatsim-data.json`);
            if (!response.ok) throw new Error(`VATSIM network response was not ok`);
            const vatsimData = await response.json();

            if (!vatsimData || !vatsimData.controllers) {
                throw new Error("Invalid data received from VATSIM API.");
            }
            
            const depAirportInfo = getDynamicAirportInfo(depIcao, vatsimData);
            const arrAirportInfo = getDynamicAirportInfo(arrIcao, vatsimData);

 
            
            departureResultsDiv.innerHTML = generateAirportHtml(depAirportInfo);
            arrivalResultsDiv.innerHTML = generateAirportHtml(arrAirportInfo);

            const depServices = analyzeTopDownServices(depAirportInfo);
            const arrServices = analyzeTopDownServices(arrAirportInfo);
            
            // Add center information to the services objects
            depServices.center= depAirportInfo.center;
            arrServices.center = arrAirportInfo.center;
            
            renderTopDownResults(depServices, arrServices);
            
            const phraseologyData = generateFlightPhraseology(callsign, depServices, arrServices);
            createAccordion('flight-phraseology-accordion', phraseologyData);

            if (!isRefresh) {
                if(refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(() => lookupFlightPlanFrequencies(true), 300000); // 5 minutes
            }
            lastUpdatedContainer.innerHTML = `Last updated: ${new Date().toLocaleTimeString()}`;

        } catch (error) {
            console.error("Lookup Error:", error);
            const errorHtml = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert"><p class="font-bold">Error</p><p>Could not fetch live data. Please check the ICAO codes and try again later.</p></div>`;
            departureResultsDiv.innerHTML = errorHtml;
            arrivalResultsDiv.innerHTML = '';
            topDownResultsDiv.innerHTML = `<div class="md:col-span-2">${errorHtml}</div>`;
            lastUpdatedContainer.innerHTML = 'Update failed.';
        }
    }
    
    fetchFlightBtn.addEventListener('click', () => lookupFlightPlanFrequencies(false));
});
</script>
</body>
</html>
